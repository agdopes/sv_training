cmake_minimum_required(VERSION 3.25)

project(gpio_hal)

enable_language(ASM)

set(CMAKE_C_COMPILER arm-none-eabi-gcc)
set(CMAKE_ASM_COMPILER arm-none-eabi-gcc)
set(CMAKE_OBJCOPY arm-none-eabi-objcopy)
set(CMAKE_EXE_LINKER_FLAGS "-T ${CMAKE_CURRENT_SOURCE_DIR}/bsp/boards/nucleo_g0b1re/STM32G0B1RETX_FLASH.ld -Wl,-Map=${CMAKE_CURRENT_BINARY_DIR}/app.map"
)
set(CMAKE_SIZE arm-none-eabi-size)
	

add_executable(${PROJECT_NAME}
	hal/testapp/gpio/main.c
	hal/testapp/gpio/system_stm32g0xx.c
	bsp/boards/nucleo_g0b1re/startup_stm32g0b1retx.s
	hal/src/hal_gpio.c
	hal/src/hal_rcc.c
	hal/drivers/stm32g0/gpio_stm32g0.c
	hal/drivers/stm32g0/rcc_stm32g0.c
)
target_include_directories(${PROJECT_NAME}
	PUBLIC
	hal/inc/
	hal/drivers/CMSIS/Device/ST/STM32G0xx/Include/
	hal/drivers/CMSIS/Include/
	hal/drivers/inc/
	hal/test_app/gpio/
)
target_link_options(${PROJECT_NAME}
 PRIVATE
 	--specs=nano.specs
 	-mcpu=cortex-m0plus
 	-Wl,--gc-sections
	-static
	-Wl,--start-group
	-lc
	-lm
	-Wl,--end-group
	-mthumb
	-mfloat-abi=soft
	
)
	
target_compile_options(${PROJECT_NAME}
 PRIVATE
 	-mcpu=cortex-m0plus
	-std=gnu11
	-g3
	-c
	-O0
	-ffunction-sections # Place functions in separate sections
	-fdata-sections # Place data in separate sections
	-fstack-usage
	--specs=nano.specs
	-mfloat-abi=soft
	-mthumb
	-DHAL_GPIO_STM32G0B1RE
	-DSTM32G0B1xx

)

# # Convert .elf firmware to .bin after build
add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
  COMMAND ${CMAKE_OBJCOPY} -O binary ${PROJECT_NAME} ${PROJECT_NAME}.bin
)

add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
  COMMAND ${CMAKE_SIZE} ${PROJECT_NAME}
)
